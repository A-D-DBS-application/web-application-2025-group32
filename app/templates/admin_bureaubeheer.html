{% extends "base.html" %}

{% block title %}Bureaubeheer{% endblock %}

{% block hero %}
  <h1 style="margin:0;font-size:2.2rem">Bureaubeheer</h1>
  <p style="margin:8px 0 0 0;opacity:0.95">Beheer bureaus en hun eigenschappen</p>
{% endblock %}

{% block content %}
<div class="container main-content bureaubeheer-content">
  <style>
    .bureaubeheer-content .card { margin-bottom: 24px; }
    .metrics-grid, .insight-box, .feedback-section, .section-header { width: 100%; }
    table { width: 100%; border-collapse: collapse; table-layout: auto; }
    th, td { font-size: 15px; padding: 12px 10px; vertical-align: middle; white-space: normal; word-break: normal; }
    .desk-row, .desk-row-edit { border-bottom: 1px solid #e5e7eb; }
    .desk-row-edit { background: #fffbeb; }
    .edit-field-wrapper label { font-size: 0.85rem; color: #64748b; margin-bottom: 4px; font-weight: 500; }
    .edit-input-number, .edit-input-other, .edit-input-floor, .edit-select { width: 100%; font-size: 15px; padding: 8px; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 4px; }
    .btn, .edit-btn-save, .edit-btn-cancel { font-size: 15px; padding: 10px 16px; margin-bottom: 0; }
    .dienst-badge { background: #e8f5e9; color: #2e7d32; padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: 600; }
    .dienst-badge-none { background: #f3f4f6; color: #64748b; padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: 600; }
    @media (max-width: 900px) {
      .bureaubeheer-content { padding: 0 6px; }
      .card { padding: 14px; }
      th, td { font-size: 13px; padding: 10px 6px; vertical-align: middle; white-space: normal; word-break: normal; }
      .edit-field-wrapper label { font-size: 0.8rem; }
      .btn, .edit-btn-save, .edit-btn-cancel { font-size: 14px; padding: 8px 10px; }
      .edit-input-number, .edit-input-other, .edit-input-floor, .edit-select { font-size: 13px; padding: 7px; }
      .dienst-badge, .dienst-badge-none { font-size: 12px; padding: 3px 8px; }
      table { display: block; width: 100%; overflow-x: auto; }
    }
  </style>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        {% if category == 'success' %}
          <div style="background:#e8f5e9;border-left:4px solid #4caf50;padding:16px;margin-bottom:24px;border-radius:8px">
            <p style="margin:0;color:#2e7d32">{{ msg }}</p>
          </div>
        {% else %}
          <div style="background:#ffebee;border-left:4px solid #f44336;padding:16px;margin-bottom:24px;border-radius:8px">
            <p style="margin:0;color:#c62828">{{ msg }}</p>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card" style="margin-bottom:24px">
    <h2 style="margin:0 0 16px 0;font-size:1.5rem;color:var(--primary)">Overzicht</h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
      <div style="padding:20px;border:2px solid #e5e7eb;border-radius:8px">
        <div style="font-size:2rem;font-weight:bold;margin-bottom:4px;color:var(--primary)">{{ desks|length }}</div>
        <div style="color:#64748b">Totaal bureaus</div>
      </div>
      <div style="padding:20px;border:2px solid #e5e7eb;border-radius:8px">
        <div style="font-size:2rem;font-weight:bold;margin-bottom:4px;color:var(--primary)">{{ diensten|length }}</div>
        <div style="color:#64748b">Actieve diensten</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="margin:0;font-size:1.5rem;color:var(--primary)">Alle Bureaus</h2>
      <a href="{{ url_for('main.admin_dashboard', add_new=1) }}" class="btn" style="padding:10px 20px;text-decoration:none;display:inline-block;background:#4caf50">
        + Nieuw bureau toevoegen
      </a>
    </div>
    
    {% if edit_mode and edit_desk_id %}
      <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:16px;margin-bottom:20px;border-radius:8px">
        <p style="margin:0;color:#856404;font-weight:500">Wijzigingsmodus actief voor bureau {{ edit_desk_number }}</p>
      </div>
    {% endif %}
    
    {% if add_new %}
      <div style="background:#e8f5e9;border:2px solid #4caf50;padding:24px;margin-bottom:24px;border-radius:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0;color:#2e7d32;font-size:1.2rem">Nieuw Bureau Toevoegen</h3>
          <a href="{{ url_for('main.admin_dashboard') }}" style="color:#2e7d32;text-decoration:none;font-weight:500">âœ• Annuleren</a>
        </div>
        
        <form method="POST" action="{{ url_for('main.admin_create_desk') }}" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
          <!-- Bureau nummer -->
          <div>
            <label style="display:block;font-size:0.85rem;color:#64748b;margin-bottom:4px;font-weight:500">Bureau nummer *</label>
            <input type="number" name="desk_number" required min="1" step="1" placeholder="bijv. 1"
                   style="padding:8px;border:1px solid #4caf50;border-radius:6px;width:100%;font-size:0.9rem">
            <small style="color:#64748b;font-size:0.75rem">Alleen positieve cijfers vanaf 1</small>
          </div>
          
          <!-- Gebouw -->
          <div>
            <label style="display:block;font-size:0.85rem;color:#64748b;margin-bottom:4px;font-weight:500">Gebouw *</label>
            <select name="building_id" id="building-new" onchange="toggleOtherInput(this, 'building-other-new')" required
                    style="padding:8px 12px;border:1px solid #4caf50;border-radius:6px;font-size:0.9rem;width:100%;cursor:pointer;background:white">
              <option value="">-- Selecteer gebouw --</option>
              {% for building in buildings %}
                <option value="{{ building.id }}">{{ building.naam }}</option>
              {% endfor %}
              <option value="other">Nieuw...</option>
            </select>
            <input type="text" name="building_other" id="building-other-new" placeholder="Nieuw gebouw naam"
                   style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;width:100%;font-size:0.9rem;margin-top:8px;display:none">
          </div>
          
          <!-- Verdieping -->
          <div>
            <label style="display:block;font-size:0.85rem;color:#64748b;margin-bottom:4px;font-weight:500">Verdieping *</label>
            <input type="number" name="floor" required min="0" max="20" step="1" value="1" placeholder="bijv. 1"
                   style="padding:8px;border:1px solid #4caf50;border-radius:6px;width:100%;font-size:0.9rem">
          </div>
          
          <!-- Scherm -->
          <div>
            <label style="display:block;font-size:0.85rem;color:#64748b;margin-bottom:4px;font-weight:500">Scherm</label>
            <select name="screen" id="screen-new" onchange="toggleOtherInput(this, 'screen-other-new')"
                    style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:0.9rem;width:100%;cursor:pointer;background:white">
              <option value="">-- Geen --</option>
              {% for screen in screens %}
                <option value="{{ screen }}">{{ screen }}</option>
              {% endfor %}
              <option value="other">Nieuw...</option>
            </select>
            <input type="text" name="screen_other" id="screen-other-new" placeholder="Nieuw scherm type"
                   style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;width:100%;font-size:0.9rem;margin-top:8px;display:none">
          </div>
          
          <!-- Stoel -->
          <div>
            <label style="display:block;font-size:0.85rem;color:#64748b;margin-bottom:4px;font-weight:500">Stoel</label>
            <select name="chair" id="chair-new" onchange="toggleOtherInput(this, 'chair-other-new')"
                    style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:0.9rem;width:100%;cursor:pointer;background:white">
              <option value="">-- Geen --</option>
              {% for chair in chairs %}
                <option value="{{ chair }}">{{ chair }}</option>
              {% endfor %}
              <option value="other">Nieuw...</option>
            </select>
            <input type="text" name="chair_other" id="chair-other-new" placeholder="Nieuw stoel type"
                   style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;width:100%;font-size:0.9rem;margin-top:8px;display:none">
          </div>
          
          <!-- Dienst -->
          <div>
            <label style="display:block;font-size:0.85rem;color:#64748b;margin-bottom:4px;font-weight:500">Dienst</label>
            <select name="dienst_id" id="dienst-select-new" onchange="toggleOtherInput(this, 'dienst-other-new')"
                    style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:6px;font-size:0.9rem;width:100%;cursor:pointer;background:white">
              <option value="None">Geen dienst</option>
              {% for dienst in diensten %}
                <option value="{{ dienst.naam }}">{{ dienst.naam }}</option>
              {% endfor %}
              <option value="other">Nieuw...</option>
            </select>
            <input type="text" name="dienst_other" id="dienst-other-new" placeholder="Nieuwe dienst naam"
                   style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;width:100%;font-size:0.9rem;margin-top:8px;display:none">
          </div>
          
          <!-- Submit button -->
          <div style="grid-column:1/-1;display:flex;gap:8px;margin-top:8px">
            <button type="submit" class="btn" style="padding:12px 24px;background:#4caf50;white-space:nowrap;font-weight:600">
              Bureau Toevoegen
            </button>
            <a href="{{ url_for('main.admin_dashboard') }}" class="btn" style="padding:12px 24px;background:#94a3b8;text-decoration:none;white-space:nowrap">
              Annuleren
            </a>
          </div>
        </form>
      </div>
    {% endif %}
    
    {% if desks %}
      <div class="bureaus-table-wrapper">
        <table class="bureaus-table" style="width:100%;border-collapse:collapse;table-layout:fixed">
          <colgroup>
            <col style="width:10%">
            <col style="width:8%">
            <col style="width:10%">
            <col style="width:15%">
            <col style="width:15%">
            <col style="width:17%">
            <col style="width:25%">
          </colgroup>
          <thead>
            <tr style="background:var(--primary);color:white">
              <th style="padding:12px 16px;text-align:left;font-weight:600;border-radius:8px 0 0 0">Bureau nummer</th>
              <th style="padding:12px 16px;text-align:left;font-weight:600">Gebouw</th>
              <th style="padding:12px 16px;text-align:left;font-weight:600">Verdieping</th>
              <th style="padding:12px 16px;text-align:left;font-weight:600">Scherm</th>
              <th style="padding:12px 16px;text-align:left;font-weight:600">Stoel</th>
              <th style="padding:12px 16px;text-align:left;font-weight:600">Dienst</th>
              <th style="padding:12px 16px;text-align:center;font-weight:600;border-radius:0 8px 0 0">Acties</th>
            </tr>
          </thead>
          <tbody>
            {% for desk in desks %}
            {% if edit_mode and edit_desk_id == desk.desk_id %}
            <tr id="desk-{{ desk.desk_id }}" class="desk-row-edit">
              <form method="POST" action="{{ url_for('main.admin_update_desk', desk_id=desk.desk_id) }}" id="edit-form-{{ desk.desk_id }}">
                <td class="desk-cell-primary">
                  <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px">Bureau</label>
                  <input type="number" name="desk_number" value="{{ desk.desk_number }}" min="1" required class="edit-input-number" />
                </td>
                <td class="desk-cell">
                  <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px">Gebouw</label>
                  <select name="building_id" id="building-edit-{{ desk.desk_id }}" onchange="toggleOtherInput(this, 'building-other-edit-{{ desk.desk_id }}')" class="edit-select" required>
                    {% for building in buildings %}
                      <option value="{{ building.id }}" {% if desk.building_id == building.id %}selected{% endif %}>{{ building.naam }}</option>
                    {% endfor %}
                    <option value="other">Nieuw...</option>
                  </select>
                  <input type="text" name="building_other" id="building-other-edit-{{ desk.desk_id }}" placeholder="Nieuw gebouw" class="edit-input-other" style="display:none;margin-top:4px" />
                </td>
                <td class="desk-cell">
                  <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px">Verdieping</label>
                  <input type="number" name="building_floor" value="{{ desk.building_floor if desk.building_floor is not none else '' }}" min="0" max="20" required class="edit-input-floor" />
                </td>
                <td class="desk-cell-muted">
                  <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px">Scherm</label>
                  <select name="screen" id="screen-edit-{{ desk.desk_id }}" onchange="toggleOtherInput(this, 'screen-other-edit-{{ desk.desk_id }}')" class="edit-select">
                    <option value="">-- Geen --</option>
                    {% for screen in screens %}
                      <option value="{{ screen }}" {% if desk.screen == screen %}selected{% endif %}>{{ screen }}</option>
                    {% endfor %}
                    <option value="other">Nieuw...</option>
                  </select>
                  <input type="text" name="screen_other" id="screen-other-edit-{{ desk.desk_id }}" placeholder="Nieuw scherm" class="edit-input-other" style="display:none;margin-top:4px" />
                </td>
                <td class="desk-cell-muted">
                  <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px">Stoel</label>
                  <select name="chair" id="chair-edit-{{ desk.desk_id }}" onchange="toggleOtherInput(this, 'chair-other-edit-{{ desk.desk_id }}')" class="edit-select">
                    <option value="">-- Geen --</option>
                    {% for chair in chairs %}
                      <option value="{{ chair }}" {% if desk.chair == chair %}selected{% endif %}>{{ chair }}</option>
                    {% endfor %}
                    <option value="other">Nieuw...</option>
                  </select>
                  <input type="text" name="chair_other" id="chair-other-edit-{{ desk.desk_id }}" placeholder="Nieuwe stoel" class="edit-input-other" style="display:none;margin-top:4px" />
                </td>
                <td class="desk-cell">
                  <label style="display:block;font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:4px">Dienst</label>
                  <select name="dienst_id" id="dienst-edit-{{ desk.desk_id }}" onchange="toggleOtherInput(this, 'dienst-other-edit-{{ desk.desk_id }}')" class="edit-select">
                    <option value="None">Geen dienst</option>
                    {% for dienst in diensten %}
                      <option value="{{ dienst.naam }}" {% if desk.dienst == dienst.naam %}selected{% endif %}>{{ dienst.naam }}</option>
                    {% endfor %}
                    <option value="other">Nieuw...</option>
                  </select>
                  <input type="text" name="dienst_other" id="dienst-other-edit-{{ desk.desk_id }}" placeholder="Nieuwe dienst" class="edit-input-other" style="display:none;margin-top:4px" />
                </td>
                <td style="padding:16px;text-align:center">
                  <button type="submit" class="btn edit-btn-save">Opslaan</button>
                  <a href="{{ url_for('main.admin_dashboard', _anchor='desk-' + desk.desk_id|string) }}" class="btn edit-btn-cancel">Annuleren</a>
                </td>
              </form>
            </tr>
            {% else %}
            <tr id="desk-{{ desk.desk_id }}" class="desk-row">
              <td class="desk-cell-primary">{{ desk.desk_number }}</td>
              <td class="desk-cell">{{ desk.building_adress }}</td>
              <td class="desk-cell">{{ desk.building_floor if desk.building_floor is not none else '-' }}</td>
              <td class="desk-cell-muted">{{ desk.screen }}</td>
              <td class="desk-cell-muted">{{ desk.chair }}</td>
              <td class="desk-cell">
                {% if desk.dienst %}
                  <span class="dienst-badge">{{ desk.dienst }}</span>
                {% else %}
                  <span class="dienst-badge-none">Geen dienst</span>
                {% endif %}
              </td>
              <td style="padding:16px;text-align:center">
                <a href="{{ url_for('main.admin_dashboard', edit=desk.desk_id, _anchor='desk-' + desk.desk_id|string) }}" class="btn" style="padding:8px 16px;margin-right:8px;text-decoration:none;display:inline-block">Wijzigen</a>
                <form method="POST" action="{{ url_for('main.admin_delete_desk', desk_id=desk.desk_id) }}" style="display:inline-block" onsubmit="return confirm('Ben je zeker dat je bureau {{ desk.desk_number }} wilt verwijderen?');">
                  <button type="submit" class="btn" style="padding:8px 16px;background:#f44336;text-decoration:none">Verwijder</button>
                </form>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div style="text-align:center;padding:40px;color:#64748b">
        <p style="font-size:1.1rem;margin:0">Geen bureaus gevonden in de database.</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
function toggleOtherInput(selectElement, inputId) {
  const inputElement = document.getElementById(inputId);
  if (selectElement.value === 'other') {
    inputElement.style.display = 'block';
    inputElement.required = true;
  } else {
    inputElement.style.display = 'none';
    inputElement.required = false;
    inputElement.value = '';
  }
}

// Scroll naar edit row met offset zodat het in het midden van scherm komt
function scrollToAnchor() {
  const hash = window.location.hash;
  if (hash) {
    const element = document.querySelector(hash);
    if (element) {
      const elementPosition = element.getBoundingClientRect().top + window.pageYOffset;
      const offsetPosition = elementPosition - (window.innerHeight / 2) + (element.offsetHeight / 2);
      
      window.scrollTo({
        top: offsetPosition,
        behavior: 'smooth'
      });
    }
  }
}

// Probeer meerdere keren om te scrollen
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(scrollToAnchor, 50);
  setTimeout(scrollToAnchor, 150);
  setTimeout(scrollToAnchor, 300);
});

// Extra check voor als DOMContentLoaded al gefired is
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  setTimeout(scrollToAnchor, 50);
  setTimeout(scrollToAnchor, 150);
  setTimeout(scrollToAnchor, 300);
}

// Ook luisteren naar load event (na alle afbeeldingen/resources)
window.addEventListener('load', function() {
  setTimeout(scrollToAnchor, 50);
});
</script>

{% endblock %}