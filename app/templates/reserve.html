{% extends 'base.html' %}

{% block title %}Nieuwe Reservatie - Colruyt{% endblock %}

{% block hero %}
  <h1 style="margin:0;font-size:2.2rem">Nieuwe Reservatie</h1>
  <p style="margin:8px 0 0 0;opacity:0.95">Zoek een beschikbaar bureau</p>
{% endblock %}

{% block content %}
<div style="max-width:700px;margin:0 auto">
  <div class="card">
    <form method="POST">
      <div style="display:grid;gap:20px">
        <div>
          <label class="small">Gebouw</label>
          <select name="building_id" id="building-select" required>
            <option value="">-- Kies een gebouw --</option>
            {% for building in buildings %}
              <option value="{{ building.adress }}" {% if saved and saved.building_id|string == building.adress|string %}selected{% endif %}>{{ building.adress }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="small">Verdieping (optioneel)</label>
          <select name="floor" id="floor-select" {% if not saved or not saved.building_id %}disabled{% endif %}>
            <option value="">-- Kies eerst een gebouw --</option>
            {% if saved and saved.building_id %}
              {% for f in floors %}
                <option value="{{ f }}" {% if saved and saved.floor|string == f|string %}selected{% endif %}>Verdieping {{ f }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>
        <div>
          <label class="small">Datum</label>
          <input type="date" name="date" value="{{ saved.date if saved else '' }}" required />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div>
            <label class="small">Begintijd</label>
            <input type="time" name="start_time" value="{{ saved.start_time if saved else '' }}" required />
          </div>
          <div>
            <label class="small">Eindtijd</label>
            <input type="time" name="end_time" value="{{ saved.end_time if saved else '' }}" required />
          </div>
        </div>
        <div style="text-align:center;margin-top:8px">
          <button class="btn" type="submit" style="min-width:280px">Beschikbare bureaus tonen</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
// Update floor dropdown wanneer building wordt geselecteerd
const buildingSelect = document.getElementById('building-select');
const floorSelect = document.getElementById('floor-select');

buildingSelect.addEventListener('change', function() {
  const adress = this.value;
  
  // Als geen gebouw geselecteerd, disable floor dropdown
  if (!adress) {
    floorSelect.disabled = true;
    floorSelect.innerHTML = '<option value="">-- Kies eerst een gebouw --</option>';
    return;
  }
  
  // Haal verdiepingen op voor dit adres
  fetch(`/api/floors/${encodeURIComponent(adress)}`)
    .then(response => response.json())
    .then(data => {
      // Reset dropdown
      floorSelect.innerHTML = '<option value="">-- Alle verdiepingen --</option>';
      
      // Voeg verdiepingen toe
      if (data.floors && data.floors.length > 0) {
        data.floors.forEach(floor => {
          const option = document.createElement('option');
          option.value = floor;
          option.textContent = `Verdieping ${floor}`;
          floorSelect.appendChild(option);
        });
        floorSelect.disabled = false;
      } else {
        floorSelect.disabled = true;
      }
    })
    .catch(error => {
      console.error('Fout bij ophalen verdiepingen:', error);
      floorSelect.disabled = true;
    });
});

// Trigger de change event als er al een gebouw geselecteerd is (bij page load)
if (buildingSelect.value) {
  buildingSelect.dispatchEvent(new Event('change'));
}
</script>
{% endblock %}