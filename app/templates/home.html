{% extends 'base.html' %}

{% block title %}Home - Colruyt Reservaties{% endblock %}

{% block hero %}
  <h1 style="margin:0;font-size:2.2rem">Welkom, {{ user_display or user }}</h1>
  <p style="margin:8px 0 0 0;opacity:0.95;font-size:1.05rem">Beheer je bureau reservaties</p>
{% endblock %}

{% block content %}
<style>
.notif-deleted {
    background: #fee;
    border-left: 4px solid #f44336;
}
.notif-modified {
    background: #fff3e0;
    border-left: 4px solid #ff6200;
}
.notif-box {
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 4px;
}
</style>

<!-- Notificatie Modal -->
{% if notifications and notifications|length > 0 %}
<div id="notificationModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 32px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
        <h2 style="color: var(--primary); margin: 0 0 20px 0; font-size: 24px;">
            ‚ö†Ô∏è Reservatie Wijzigingen
        </h2>
        
        <p style="color: #666; margin-bottom: 24px;">
            De beheerder heeft de volgende wijzigingen aangebracht aan je reservaties:
        </p>
        
        {% for notif in notifications %}
        <div class="notif-box {% if notif.notification_type == 'deleted' %}notif-deleted{% else %}notif-modified{% endif %}">
            <h4 style="margin: 0 0 8px 0; color: var(--text); font-size: 16px;">
                {% if notif.notification_type == 'deleted' %}
                    üóëÔ∏è Reservatie verwijderd
                {% else %}
                    ‚úèÔ∏è Reservatie gewijzigd
                {% endif %}
            </h4>
            
            <p style="margin: 0 0 12px 0; color: var(--text);">{{ notif.message }}</p>
            
            <div style="background: white; padding: 12px; border-radius: 4px; font-size: 14px;">
                {% if notif.notification_type == 'deleted' %}
                    <p style="margin: 0; color: #666;"><strong>Verwijderde reservatie:</strong></p>
                    <ul style="margin: 8px 0 0 0; padding-left: 20px; color: var(--text);">
                        <li>Bureau: {{ notif.deleted_desk_number }}</li>
                        <li>Gebouw: {{ notif.deleted_building }}</li>
                        <li>Datum: {{ notif.deleted_date }}</li>
                        <li>Tijd: {{ notif.deleted_time }}</li>
                    </ul>
                {% else %}
                    <p style="margin: 0 0 8px 0; color: #666;"><strong>Gewijzigd:</strong></p>
                    <div style="padding: 8px 0;">
                        <strong style="color: #666;">{{ notif.changed_field|capitalize }}:</strong><br>
                        <span style="color: #f44336; text-decoration: line-through;">{{ notif.old_value }}</span>
                        <span style="color: #666; margin: 0 8px;">‚Üí</span>
                        <span style="color: #4caf50; font-weight: 600;">{{ notif.new_value }}</span>
                    </div>
                {% endif %}
            </div>
            
            <p class="small" style="margin: 12px 0 0 0; color: #999;">
                {{ notif.created_at.strftime('%d/%m/%Y om %H:%M') }}
            </p>
        </div>
        {% endfor %}
        
        <button onclick="closeNotifications()" 
                data-notification-ids="{% for n in notifications %}{{ n.notification_id }}{% if not loop.last %},{% endif %}{% endfor %}"
                style="width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 8px;">
            Begrepen
        </button>
    </div>
</div>

<script>
function closeNotifications() {
    var button = event.target;
    var idsString = button.getAttribute('data-notification-ids');
    var notificationIds = idsString.split(',').map(function(id) { return parseInt(id); });
    
    fetch('/api/notifications/mark-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ notification_ids: notificationIds })
    }).then(function() {
        document.getElementById('notificationModal').style.display = 'none';
    });
}
</script>
{% endif %}

<div class="container main-content">
  <div class="home-layout">
    <aside class="home-sidebar card">
      <h3 class="sidebar-title">Snelle acties</h3>
      <div class="sidebar-actions">
        <a class="btn" href="{{ url_for('main.reserve') }}">Nieuwe reservatie</a>
        <a class="btn btn-secondary" href="{{ url_for('main.mijn_reservaties') }}">Mijn reservaties</a>
        {% if is_admin %}
        <a class="btn" href="{{ url_for('main.feedback_analysis') }}">Feedback analyse</a>
        <a class="btn" href="{{ url_for('main.admin_dashboard') }}">Bureaubeheer</a>
        <a class="btn" href="{{ url_for('main.admin_reservations_overview') }}">Reservaties beheren</a>
        {% endif %}
      </div>
    </aside>
    <main class="home-main">
      <div class="card" style="margin-bottom:28px">
        <h2 style="margin:0 0 6px 0;color:var(--primary)">Aankomende reservaties</h2>
        <p class="small" style="margin-bottom:20px;color:var(--muted)">Je reservaties voor de komende week</p>
        {% if upcoming and upcoming|length > 0 %}
        <table class="data-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Tijd</th>
              <th>Bureau</th>
              <th>Gebouw</th>
            </tr>
          </thead>
          <tbody>
            {% for r in upcoming %}
            {% if r.modified_by_admin %}
            <tr>
              <td colspan="4" style="padding:8px 12px;background:#fff3cd;border-left:4px solid #ff8c00;border-bottom:none;">
                <span style="color:#ff8c00;font-weight:700;font-size:0.85rem">‚ö† Deze reservatie is aangepast door de beheerder</span>
              </td>
            </tr>
            <tr style="background:#fff3cd;">
              <td style="border-left:4px solid #ff8c00;border-top:none;padding-top:4px;">{{ r.starttijd.strftime('%d/%m/%Y') if r.starttijd else '-' }}</td>
              <td style="border-top:none;padding-top:4px;">{{ r.starttijd.strftime('%H:%M') if r.starttijd else '-' }} - {{ r.eindtijd.strftime('%H:%M') if r.eindtijd else '-' }}</td>
              <td style="border-top:none;padding-top:4px;">Bureau {{ r.desk_number or 'N/A' }}</td>
              <td style="border-top:none;padding-top:4px;">{{ r.building_adress or 'N/A' }}</td>
            </tr>
            {% else %}
            <tr>
              <td>{{ r.starttijd.strftime('%d/%m/%Y') if r.starttijd else '-' }}</td>
              <td>{{ r.starttijd.strftime('%H:%M') if r.starttijd else '-' }} - {{ r.eindtijd.strftime('%H:%M') if r.eindtijd else '-' }}</td>
              <td>Bureau {{ r.desk_number or 'N/A' }}</td>
              <td>{{ r.building_adress or 'N/A' }}</td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div style="padding:40px;text-align:center;color:var(--muted)">
          <p>Geen aankomende reservaties.</p>
          <a class="btn" href="{{ url_for('main.reserve') }}" style="margin-top:16px;display:inline-block">Maak een reservatie</a>
        </div>
        {% endif %}
      </div>
      {% if completed and completed|length > 0 %}
      <div class="card">
        <h2 style="margin:0 0 6px 0;color:var(--primary)">Voltooide reservaties</h2>
        <p class="small" style="margin-bottom:20px;color:var(--muted)">Geef feedback over je ervaring</p>
        <table class="data-table">
          <thead>
            <tr>
              <th>Datum</th>
              <th>Tijd</th>
              <th>Bureau</th>
              <th>Gebouw</th>
              <th>Feedback</th>
            </tr>
          </thead>
          <tbody>
            {% for r in completed %}
            <tr>
              <td>{{ r.starttijd.strftime('%d/%m/%Y') if r.starttijd else '-' }}</td>
              <td>
                <span style="display:inline-flex;align-items:center;gap:4px;">
                  <span>{{ r.starttijd.strftime('%H:%M') if r.starttijd else '-' }}</span>
                  <span style="font-weight:600;color:var(--muted)">‚Äì</span>
                  <span>{{ r.eindtijd.strftime('%H:%M') if r.eindtijd else '-' }}</span>
                </span>
              </td>
              <td>Bureau {{ r.desk_number or 'N/A' }}</td>
              <td>{{ r.building_adress or 'N/A' }}</td>
              <td>
                {% if r.has_feedback %}
                  <span style="color:var(--success);font-size:0.9rem;margin-right:8px">‚úì Gegeven</span>
                  <a class="btn-secondary" href="{{ url_for('main.feedback', res_id=r.res_id) }}" style="padding:6px 12px;font-size:0.85rem">Bewerk</a>
                {% else %}
                  <a class="btn" href="{{ url_for('main.feedback', res_id=r.res_id) }}" style="padding:6px 12px;font-size:0.85rem">Geef feedback</a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </main>
  </div>
</div>
<style>
  .home-layout { display: flex; gap: 28px; margin-top: 0; }
  .home-sidebar { width: 280px; flex-shrink: 0; }
  .sidebar-title { margin: 0 0 18px 0; color: var(--primary); font-size: 1.15rem; }
  .sidebar-actions { display: flex; flex-direction: column; gap: 12px; }
  @media (max-width: 700px) {
    .sidebar-actions {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
    }
    .sidebar-actions a.btn, .sidebar-actions a.btn-secondary {
      width: auto;
      min-width: 120px;
      margin-bottom: 0;
      font-size: 15px;
      padding: 10px 8px;
    }
  }
  .home-main { flex: 1; }
  @media (max-width: 800px) {
    .home-layout { flex-direction: column; gap: 18px; }
    .home-sidebar { width: 100%; }
    .home-main { width: 100%; }
  }
</style>
{% endblock %}